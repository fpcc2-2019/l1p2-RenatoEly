---
title: "EDA buscas"
output: html_notebook
---

O objeto principal da análise são as buscas e a navegação depois da busca. Criamos esses dados a partir dos dados originais da wikimedia em `/data/search_data.csv`. 

Aqui, exploramos esses dados. 

```{r setup}
library(tidyverse)
library(here)
library(lubridate)
theme_set(theme_bw())
```

```{r ETL}
buscas = read_csv(here::here("data/search_data.csv"))
```

```{r}
buscas %>% 
    ggplot(aes(x = num_clicks)) + 
    geom_histogram(binwidth = 1)
```

Removendo hora e minuto da data para identificar apenas o dia.

```{r}
buscas$session_start_date <- buscas$session_start_date %>% as.Date("%d/%m/%Y")
```

```{r}
buscas %>% ggplot(aes(x=session_start_date)) +
    geom_histogram()
```

```{r}
buscas %>%  ggplot(aes(x=session_length, y=num_clicks))+
    geom_point()+
    labs(title = "All data")

buscas %>% filter(session_length <= 100000) %>%  ggplot(aes(x=session_length, y=num_clicks))+
    geom_point()+
    labs(title = "session legth < 10^5")

buscas %>% filter(session_length >= 500000) %>%  ggplot(aes(x=session_length, y=num_clicks))+
    geom_point()+
    labs(title = "session legth > 10^5")
```


```{r}
buscas %>% filter(num_clicks > 10) %>%  ggplot(aes(x=session_length, y=num_clicks))+
    geom_point()+
    labs(title = "Num clicks > 10")

buscas %>% filter(num_clicks == 0) %>% summarise(qtd=n()) / buscas %>% filter(num_clicks >= 0) %>% summarise(qtd=n())
```

o ponto num clicks = 30 parece estranho, pois foram 30 páginas visitadas em 4 min.

75% das pesquisas não tiveram clicks em nenhum dos seus resultados.

```{r}
buscas %>% filter(first_click != "NA") %>% ggplot(aes(x=first_click))+
    geom_histogram(binwidth = 10)

buscas %>% filter(first_click >= 0 & first_click <= 10) %>% 
    ggplot(aes(x=first_click))+
    geom_histogram()
```

```{r}
cdf <- buscas %>% filter(first_click != "NA") %>% group_by(first_click) %>% summarise(qtd = n()) %>% 
    mutate(cumulative=cumsum(qtd)/sum(qtd))

cdf %>% 
    ggplot(aes(x=first_click,y=cumulative))+
    geom_line()+
    scale_y_continuous(limits=c(0, 1))

```

```{r}
cdf %>% filter(cumulative <= 0.99) %>% 
    ggplot(aes(x=first_click,y=cumulative))+
    geom_line()
```

```{r}
sumario <- buscas %>% group_by(session_id) %>% summarise(length = mean(session_length), clicks = mean(num_clicks))

sumario %>% filter(length > 0) %>% 
    ggplot(aes(x=length, y=clicks))+
    geom_point()

buscas %>% group_by(session_id) %>% summarise(qtd=n()) %>% 
    ggplot(aes(x="QTD", y=qtd))+
    geom_boxplot()
```

1-What is our daily overall clickthrough rate? How does it vary between the groups?

Calculando a média para cada dia.
```{r}
buscas %>% filter(!is.na(num_clicks)) %>% 
    group_by(group) %>%  
    summarise(mean=median(num_clicks)) %>% 
    ggplot(aes(x=group,y=mean))+
    geom_bar(stat = "identity")


buscas %>% filter(!is.na(num_clicks)) %>% 
    group_by(group) %>%  
    summarise(vary=var(num_clicks)) %>% 
    ggplot(aes(x=group,y=vary))+
    geom_bar(stat = "identity")

buscas %>% filter(num_clicks != "NA") %>% 
    group_by(session_start_date) %>%  
    ggplot(aes(x="Num clicks", y=num_clicks))+
    geom_boxplot()+
    facet_wrap(~group)
```

A maioria das buscas, em ambos os grupos, não possuem clicks, porém o grupo 'a' possui um range bem maior do que o grupo 'b'.


2-Which results do people tend to try first? How does it change day-to-day?

```{r}
buscas %>% filter(first_click != "NA") %>% 
    group_by(first_click) %>% 
    summarise(qtd=n()) %>% 
    filter(qtd >= 10) %>% 
    ggplot(aes(x=as.factor(first_click),y=qtd))+
    geom_bar(stat = "identity")

buscas %>% filter(first_click != "NA") %>% 
    group_by(first_click, session_start_date) %>% 
    summarise(qtd=n()) %>% 
    filter(qtd >= 10) %>% 
    ggplot(aes(x=as.factor(first_click),y=qtd))+
    geom_bar(stat = "identity")+
    theme(axis.text.x = element_text(angle = 45))+
    facet_wrap(~session_start_date, ncol = 2)
```


3-What is our daily overall zero results rate? How does it vary between the groups?

```{r}
buscas %>% filter(results == 0) %>% 
    group_by(session_start_date) %>% 
    summarise(qtd=n()) %>% 
    ggplot(aes(x=session_start_date, y =qtd))+
    geom_point()

buscas %>% filter(results == 0) %>% 
    group_by(session_start_date, group) %>% 
    summarise(qtd=n()) %>% 
    ggplot(aes(x=session_start_date, y=qtd, colour=group))+
    geom_point()

```

4-Let session length be approximately the time between the first event and the last event in a session. Choose a variable from the dataset and describe its relationship to session length. Visualize the relationship.

```{r}
buscas %>% ggplot(aes(x=session_length,y=num_clicks))+
    geom_point()

cor(buscas$session_length,buscas$num_clicks, method)
```

